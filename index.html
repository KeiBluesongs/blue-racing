<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NASCAR Strategy Sim (Prototype)</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; }

    /* ===== Layout: left track + right controls (portrait-friendly) ===== */
    #wrap { height:100vh; display:flex; flex-direction:column; }
    #top {
      flex:1;
      display:flex;
      gap:10px;
      padding:10px;
      padding-top: calc(10px + env(safe-area-inset-top));
      box-sizing:border-box;
    }

    /* Left: track area */
    #trackArea{
      flex: 0 0 62%;
      min-width: 0;
      position:relative;
      border-radius:14px;
      overflow:hidden;
      border:1px solid color-mix(in srgb, CanvasText 12%, transparent);
      background: color-mix(in srgb, Canvas 92%, transparent);
    }
    canvas { width:100%; height:100%; display:block; }

    /* Right: side controls */
    #side{
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel {
      background: color-mix(in srgb, Canvas 88%, transparent);
      border:1px solid color-mix(in srgb, CanvasText 15%, transparent);
      border-radius:12px;
      padding:10px;
      backdrop-filter: blur(8px);
    }

    #status b { font-size:14px; }
    #status .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:13px; opacity:.95; }
    #forecastBar { height:10px; border-radius:6px; overflow:hidden; background: color-mix(in srgb, CanvasText 10%, transparent); margin-top:8px; }
    #forecastFill { height:100%; width:50%; background: currentColor; opacity:.35; }

    .card {
      border:1px solid color-mix(in srgb, CanvasText 12%, transparent);
      border-radius:14px;
      padding:10px;
      background: color-mix(in srgb, Canvas 92%, transparent);
    }
    .card h3 { margin:0 0 8px; font-size:14px; }

    button, select, input[type="range"] { font-size:16px; }
    button {
      width:100%;
      padding:12px 10px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, CanvasText 18%, transparent);
      background: color-mix(in srgb, Canvas 92%, transparent);
    }
    button:active { transform: scale(0.99); }

    .btnRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { font-size:13px; opacity:.9; display:block; margin-top:6px; }
    .inline { display:flex; gap:10px; align-items:center; }
    .small { font-size:12px; opacity:.85; }

    #tableWrap { margin-top:8px; max-height: 22vh; overflow:auto; border-radius:12px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:6px 8px; border-bottom:1px solid color-mix(in srgb, CanvasText 10%, transparent); }
    th { position:sticky; top:0; background: color-mix(in srgb, Canvas 96%, transparent); text-align:left; }

    .pill {
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid color-mix(in srgb, CanvasText 18%, transparent);
      font-size:12px; opacity:.95;
    }
    .yflag { color:#a16207; font-weight:700; }
    .green { color:#166534; font-weight:700; }

    /* Bottom bar (optional) */
    #footer {
      padding:8px 10px calc(10px + env(safe-area-inset-bottom));
      border-top:1px solid color-mix(in srgb, CanvasText 12%, transparent);
      background: color-mix(in srgb, Canvas 92%, transparent);
      font-size:12px;
      opacity:.85;
    }
  </style>
</head>
<body>
<div id="wrap">

  <div id="top">

    <!-- LEFT: Track -->
    <div id="trackArea">
      <canvas id="c"></canvas>
    </div>

    <!-- RIGHT: Panels -->
    <div id="side">
      <div id="status" class="panel">
        <b>Race Status</b>
        <div class="row">
          <span class="pill" id="flagPill">GREEN</span>
          <span class="pill">Lap <span id="lap">1</span>/<span id="lapsTotal">120</span></span>
          <span class="pill">Track wet: <span id="wet">0%</span></span>
          <span class="pill">Weather: <span id="wx">Clear</span></span>
        </div>
        <div class="row">
          <span class="pill">Your pos: <span id="ypos">-</span>/<span id="carsN">12</span></span>
          <span class="pill">Fuel: <span id="fuelTxt">-</span></span>
          <span class="pill">Tire: <span id="tireTxt">-</span></span>
        </div>

        <div class="small" style="margin-top:8px;">
          Forecast (chance of rain soon):
          <div id="forecastBar"><div id="forecastFill"></div></div>
        </div>

        <div id="tableWrap">
          <table>
            <thead><tr><th>#</th><th>Driver</th><th>Gap</th><th>Status</th></tr></thead>
            <tbody id="board"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Pit Calls</h3>
        <div class="btnRow">
          <button id="pitNow">PIT NOW</button>
          <button id="pitNext">PIT NEXT</button>
        </div>
        <button id="cancelPit" style="margin-top:10px;">Cancel Pit</button>
        <div class="small" style="margin-top:8px;">
          Tip: ÈªÑÊóó‰∏≠„ÅØ„Éî„ÉÉ„Éà„É≠„Çπ„ÅåÂ∞è„Åï„ÇÅÔºÜÈöäÂàó„ÅåË©∞„Åæ„Çã„ÅÆ„ÅßÂà∫„Åï„Çä„ÇÑ„Åô„ÅÑ„ÄÇ
        </div>
      </div>

      <div class="card">
        <h3>Strategy</h3>

        <label>Tyres</label>
        <select id="tireSel" style="width:100%; padding:10px; border-radius:12px;">
          <option value="slick">Slick</option>
          <option value="inter">Intermediate</option>
          <option value="rain">Rain</option>
        </select>

        <label>Fuel target (at pit)</label>
        <div class="inline">
          <input id="fuelRange" type="range" min="20" max="100" value="85" style="flex:1;">
          <span class="pill" id="fuelTarget">85%</span>
        </div>

        <label>Pace</label>
        <select id="paceSel" style="width:100%; padding:10px; border-radius:12px;">
          <option value="save">Save (fuel/tyre)</option>
          <option value="normal" selected>Normal</option>
          <option value="push">Push</option>
        </select>

        <button id="reset" style="margin-top:10px;">Restart Race</button>
      </div>
    </div>

  </div>

  <div id="footer">You: green(slick) / blue(inter) / yellow(rain)</div>
</div>

<script>
(() => {
  // ---------- Helpers ----------
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const lerp = (a,b,t) => a + (b-a)*t;
  const rand = (a,b) => a + Math.random()*(b-a);
  const pick = (arr) => arr[(Math.random()*arr.length)|0];

  // ---------- Canvas (FIXED: correct DPR handling) ----------
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    // draw in CSS pixels
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resize);

  // ---------- Track geometry (oval) ----------
  function trackPoint(t, rect) {
    const cx = rect.x + rect.w/2;
    const cy = rect.y + rect.h/2;
    const a = rect.w/2;
    const b = rect.h/2;
    const ang = (t * Math.PI * 2) - Math.PI/2;
    return { x: cx + a*Math.cos(ang), y: cy + b*Math.sin(ang) };
  }

  // ---------- UI elements ----------
  const elLap = document.getElementById('lap');
  const elLapsTotal = document.getElementById('lapsTotal');
  const elWet = document.getElementById('wet');
  const elWx = document.getElementById('wx');
  const elFlagPill = document.getElementById('flagPill');
  const elYPos = document.getElementById('ypos');
  const elCarsN = document.getElementById('carsN');
  const elFuelTxt = document.getElementById('fuelTxt');
  const elTireTxt = document.getElementById('tireTxt');
  const elBoard = document.getElementById('board');
  const elForecastFill = document.getElementById('forecastFill');

  const pitNowBtn = document.getElementById('pitNow');
  const pitNextBtn = document.getElementById('pitNext');
  const cancelPitBtn = document.getElementById('cancelPit');
  const tireSel = document.getElementById('tireSel');
  const fuelRange = document.getElementById('fuelRange');
  const fuelTarget = document.getElementById('fuelTarget');
  const paceSel = document.getElementById('paceSel');
  const resetBtn = document.getElementById('reset');

  fuelRange.addEventListener('input', () => fuelTarget.textContent = fuelRange.value + '%');

  // ---------- Game constants ----------
  const TOTAL_LAPS = 120;
  const N = 12;
  const YOU = 0;
  const baseLapTime = 30.0;
  const pitLaneLossGreen = 13.0;
  const pitLaneLossYellow = 7.0;
  const fuelBurnPerLap = 0.045;
  const refuelRatePerSec = 0.09;
  const tireWearPerLap = 0.03;

  const driverNames = [
    "YOU", "Harper", "Mason", "Riley", "Noah", "Avery",
    "Jordan", "Logan", "Quinn", "Parker", "Reese", "Sawyer"
  ];

  const tires = {
    slick: { name:"Slick", dryGrip: 1.00, wetGrip: 0.55, wearRate: 1.00 },
    inter: { name:"Inter", dryGrip: 0.93, wetGrip: 0.82, wearRate: 1.05 },
    rain:  { name:"Rain",  dryGrip: 0.86, wetGrip: 0.98, wearRate: 1.15 },
  };

  const pace = {
    save:   { paceMul: 0.975, burnMul: 0.90, wearMul: 0.90, riskMul: 0.85 },
    normal: { paceMul: 1.00,  burnMul: 1.00, wearMul: 1.00, riskMul: 1.00 },
    push:   { paceMul: 1.025, burnMul: 1.08, wearMul: 1.12, riskMul: 1.25 },
  };

  // ---------- State ----------
  let cars, timeSec, flag, cautionTimer, cautionCause;
  let weather = { rainChance: 0.25, raining:false, wet:0.0 };
  let forecast = { nextRainPulse: rand(25, 55), pulse:0.0 };

  function init() {
    resize();
    timeSec = 0;
    flag = "GREEN";
    cautionTimer = 0;
    cautionCause = "";
    weather = { rainChance: 0.25, raining:false, wet:0.0 };
    forecast = { nextRainPulse: rand(25,55), pulse:0.0 };

    cars = [];
    for (let i=0;i<N;i++) {
      cars.push({
        id:i,
        name: driverNames[i],
        prog: (1 - i*(1/N))*0.95,
        lap: 1,
        fuel: rand(0.78, 0.95),
        tireType: i===YOU ? "slick" : pick(["slick","slick","inter"]),
        tireWear: rand(0.05, 0.22),
        inPit:false,
        pitTimeLeft:0,
        pitRequest:"NONE",
        pitPlan: { tire:"slick", fuelTarget:0.85 },
        paceMode: i===YOU ? "normal" : pick(["save","normal","normal","push"]),
        damage:0.0,
        dnf:false,
        gap:0,
      });
    }

    cars[YOU].pitPlan.tire = tireSel.value;
    cars[YOU].pitPlan.fuelTarget = (+fuelRange.value)/100;
    cars[YOU].paceMode = paceSel.value;

    elLapsTotal.textContent = TOTAL_LAPS;
    elCarsN.textContent = N;
  }

  function maybeTriggerCaution() {
    if (flag === "YELLOW") return;
    let totalRisk = 0;
    for (const car of cars) {
      if (car.dnf || car.inPit) continue;
      const mismatch = weather.wet > 0.6 && car.tireType === "slick" ? 0.035
                     : weather.wet > 0.35 && car.tireType === "slick" ? 0.018
                     : 0.0;
      const worn = car.tireWear > 0.75 ? 0.012 : 0.0;
      totalRisk += (0.0018 + mismatch + worn) * pace[car.paceMode].riskMul;
    }
    const p = clamp(totalRisk * 0.02, 0, 0.06);
    if (Math.random() < p) {
      flag = "YELLOW";
      cautionTimer = rand(18, 28);
      cautionCause = (weather.wet>0.55) ? "Spin in the wet" : "Incident";
    }
  }

  function endCaution() {
    flag = "GREEN";
    cautionTimer = 0;
    cautionCause = "";
    cars.sort((a,b)=>b.prog - a.prog);
    for (let i=0;i<cars.length;i++){
      cars[i].prog = cars[0].prog - i*0.003;
    }
  }

  function updateWeather(dt) {
    forecast.nextRainPulse -= dt;
    if (forecast.nextRainPulse <= 0) {
      forecast.pulse = rand(0.2, 1.0);
      forecast.nextRainPulse = rand(35, 70);
    } else {
      forecast.pulse = Math.max(0, forecast.pulse - dt*0.015);
    }

    const targetChance = clamp(0.18 + forecast.pulse*0.65, 0.1, 0.9);
    weather.rainChance = lerp(weather.rainChance, targetChance, dt*0.02);

    if (!weather.raining) {
      if (Math.random() < weather.rainChance * dt * 0.0035) weather.raining = true;
    } else {
      if (Math.random() < (0.15) * dt * 0.0045) weather.raining = false;
    }

    if (weather.raining) weather.wet = clamp(weather.wet + dt*0.02, 0, 1);
    else weather.wet = clamp(weather.wet - dt*0.012, 0, 1);

    elForecastFill.style.width = (weather.rainChance*100).toFixed(0) + "%";
  }

  function lapTimeMultiplier(car) {
    const t = tires[car.tireType];
    const wet = weather.wet;
    const grip = lerp(t.dryGrip, t.wetGrip, wet);
    const wearPenalty = 1.0 - (car.tireWear*0.22);
    const fuelPenalty = 1.0 - ((car.fuel)*0.05);
    const damagePenalty = 1.0 - (car.damage*0.12);
    const paceMul = pace[car.paceMode].paceMul;

    let mismatchPenalty = 1.0;
    if (wet > 0.6 && car.tireType === "slick") mismatchPenalty = 0.72;
    else if (wet > 0.35 && car.tireType === "slick") mismatchPenalty = 0.86;

    const effective = clamp(grip*wearPenalty*fuelPenalty*damagePenalty*mismatchPenalty, 0.45, 1.10);
    return (1.0 / effective) / paceMul;
  }

  function progressPerSecond(car) {
    let lt = baseLapTime * lapTimeMultiplier(car);
    if (flag === "YELLOW") lt *= (1.38 + weather.wet*0.22);
    return 1.0 / lt;
  }

  function requestPit(car, mode) { car.pitRequest = mode; }

  function enterPit(car) {
    car.inPit = true;
    car.pitRequest = "NONE";

    const loss = (flag === "YELLOW") ? pitLaneLossYellow : pitLaneLossGreen;
    const targetFuel = car.pitPlan.fuelTarget;
    const need = Math.max(0, targetFuel - car.fuel);
    const fuelTime = need / refuelRatePerSec;
    const tireTime = 2.8;
    const repairTime = car.damage > 0.25 ? 2.5 : 0.0;

    car.pitTimeLeft = loss + tireTime + fuelTime + repairTime;
  }

  function doPitWork(car, dt) {
    car.pitTimeLeft -= dt;
    if (car.pitTimeLeft <= 0) {
      car.tireType = car.pitPlan.tire;
      car.tireWear = 0.0;
      car.fuel = clamp(car.pitPlan.fuelTarget, 0, 1);
      car.damage = Math.max(0, car.damage - 0.35);
      car.inPit = false;
      car.prog -= (flag === "YELLOW") ? 0.006 : 0.012;
    }
  }

  function aiDecide(car) {
    if (car.id === YOU || car.dnf) return;

    const fuelLapsLeft = car.fuel / fuelBurnPerLap;
    const wet = weather.wet;

    let desired = "slick";
    if (wet > 0.55) desired = "rain";
    else if (wet > 0.28) desired = "inter";

    const wrongTyre = (wet > 0.5 && car.tireType === "slick") || (wet < 0.15 && car.tireType === "rain");
    const worn = car.tireWear > 0.72;

    let wantPit = false;
    if (fuelLapsLeft < 2.6) wantPit = true;
    if (worn) wantPit = true;
    if (wrongTyre) wantPit = true;

    if (wantPit && car.pitRequest === "NONE" && !car.inPit) {
      if (flag === "YELLOW" || Math.random() < 0.55) car.pitRequest = "NOW";
      else car.pitRequest = "NEXT";
      car.pitPlan.tire = desired;
      car.pitPlan.fuelTarget = (flag === "YELLOW") ? 0.82 : 0.90;
    }

    if (flag === "YELLOW") car.paceMode = "save";
    else if (fuelLapsLeft < 4.0) car.paceMode = "save";
    else car.paceMode = pick(["normal","normal","push"]);
  }

  function update(dt) {
    timeSec += dt;
    updateWeather(dt);

    if (flag === "YELLOW") {
      cautionTimer -= dt;
      if (cautionTimer <= 0) endCaution();
    } else {
      maybeTriggerCaution();
    }

    for (const car of cars) aiDecide(car);

    for (const car of cars) {
      if (car.dnf) continue;

      if (car.inPit) { doPitWork(car, dt); continue; }

      const pm = pace[car.paceMode];
      const pps = progressPerSecond(car);
      const lapsThisSec = pps * dt;

      car.fuel = clamp(car.fuel - (fuelBurnPerLap * lapsThisSec * pm.burnMul), 0, 1);
      car.tireWear = clamp(car.tireWear + (tireWearPerLap * lapsThisSec * tires[car.tireType].wearRate * pm.wearMul), 0, 1);

      let speed = pps;
      if (car.fuel <= 0.001) speed *= 0.35;

      if (flag === "YELLOW") {
        const leadProg = Math.max(...cars.filter(c=>!c.dnf && !c.inPit).map(c=>c.prog));
        const gap = leadProg - car.prog;
        speed *= clamp(1 + gap*0.6, 0.80, 1.25);
      }

      car.prog += speed * dt;

      if (car.prog >= car.lap) {
        car.lap += 1;
        if (car.pitRequest !== "NONE") enterPit(car);
        if (car.lap > TOTAL_LAPS) { car.prog = TOTAL_LAPS + 0.999; car.dnf = true; }
      }

      if (flag === "GREEN" && !car.inPit && car.lap <= TOTAL_LAPS) {
        const wet = weather.wet;
        let mismatch = 0;
        if (wet > 0.6 && car.tireType === "slick") mismatch += 0.006;
        if (car.tireWear > 0.8) mismatch += 0.004;
        if (car.fuel <= 0.02) mismatch += 0.003;

        const risk = (0.00022 + mismatch) * pace[car.paceMode].riskMul;
        if (Math.random() < risk * dt) {
          car.damage = clamp(car.damage + rand(0.08, 0.22), 0, 1);
          if (Math.random() < (0.18 + wet*0.45)) {
            flag = "YELLOW";
            cautionTimer = rand(16, 26);
            cautionCause = wet>0.55 ? "Spin / contact in rain" : "Contact";
          }
        }
      }
    }

    updateUI();
    draw();
  }

  function updateUI() {
    if (flag === "YELLOW") { elFlagPill.textContent = "YELLOW"; elFlagPill.className = "pill yflag"; }
    else { elFlagPill.textContent = "GREEN"; elFlagPill.className = "pill green"; }

    elWet.textContent = Math.round(weather.wet*100) + "%";
    elWx.textContent = weather.raining ? "Rain" : "Clear";

    const leader = cars.reduce((a,b)=> (a.prog>b.prog? a:b));
    const shownLap = clamp(Math.floor(leader.prog) + 1, 1, TOTAL_LAPS);
    elLap.textContent = shownLap;

    const you = cars[YOU];
    elFuelTxt.textContent = Math.round(you.fuel*100) + "%";
    elTireTxt.textContent = tires[you.tireType].name + (you.inPit ? " (PIT)" : "");

    const alive = cars.slice().sort((a,b)=>b.prog - a.prog);
    elYPos.textContent = alive.findIndex(c=>c.id===YOU) + 1;

    const lead = alive[0];
    const leadPps = progressPerSecond(lead);
    for (const c of alive) c.gap = (lead.prog - c.prog) / leadPps;

    let html = "";
    for (let i=0;i<alive.length;i++) {
      const c = alive[i];
      const gapTxt = (i===0) ? "‚Äî" : (c.gap.toFixed(1) + "s");
      let st = "";
      if (c.inPit) st = "PIT";
      else if (c.id===YOU && c.pitRequest!=="NONE") st = "PIT " + c.pitRequest;
      else if (c.damage>0.45) st = "DMG";

      const mark = (c.id===YOU) ? "üëâ " : "";
      html += `<tr><td>${mark}${i+1}</td><td>${c.name}</td><td>${gapTxt}</td><td>${st}</td></tr>`;
    }
    elBoard.innerHTML = html;
  }

  pitNowBtn.addEventListener('click', () => {
    const you = cars[YOU];
    you.pitPlan.tire = tireSel.value;
    you.pitPlan.fuelTarget = (+fuelRange.value)/100;
    you.paceMode = paceSel.value;
    requestPit(you, "NOW");
  });

  pitNextBtn.addEventListener('click', () => {
    const you = cars[YOU];
    you.pitPlan.tire = tireSel.value;
    you.pitPlan.fuelTarget = (+fuelRange.value)/100;
    you.paceMode = paceSel.value;
    requestPit(you, "NEXT");
  });

  cancelPitBtn.addEventListener('click', () => cars[YOU].pitRequest = "NONE");
  paceSel.addEventListener('change', () => cars[YOU].paceMode = paceSel.value);
  resetBtn.addEventListener('click', () => init());

  // ---------- Drawing (FIXED: always fit inside left panel) ----------
  function draw() {
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    ctx.clearRect(0,0,w,h);

    // Make oval "always visible": use panel size, keep generous margins
    const pad = 18;
    const rect = {
      x: pad,
      y: pad,
      w: w - pad*2,
      h: h - pad*2
    };

    // Force oval-ish aspect: slightly taller than wide (NASCAR top-view)
    // If the panel is too wide/tall, letterbox inside it.
    const targetAspect = 0.72; // width/height
    let rw = rect.w, rh = rect.h;
    const currentAspect = rw / rh;

    if (currentAspect > targetAspect) {
      // too wide -> reduce width
      const newW = rh * targetAspect;
      rect.x += (rw - newW)/2;
      rect.w = newW;
    } else {
      // too tall -> reduce height
      const newH = rw / targetAspect;
      rect.y += (rh - newH)/2;
      rect.h = newH;
    }

    // background
    ctx.fillStyle = 'rgba(0,0,0,0.04)';
    ctx.fillRect(0,0,w,h);

    // track
    ctx.save();
    ctx.lineWidth = 18;
    ctx.strokeStyle = 'rgba(80,80,80,0.65)';
    ctx.beginPath();
    ctx.ellipse(rect.x+rect.w/2, rect.y+rect.h/2, rect.w/2, rect.h/2, 0, 0, Math.PI*2);
    ctx.stroke();

    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.beginPath();
    ctx.ellipse(rect.x+rect.w/2, rect.y+rect.h/2, rect.w/2-12, rect.h/2-12, 0, 0, Math.PI*2);
    ctx.stroke();

    // start/finish
    const p0 = trackPoint(0, rect);
    ctx.strokeStyle = 'rgba(255,255,255,0.75)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(p0.x-18, p0.y);
    ctx.lineTo(p0.x+18, p0.y);
    ctx.stroke();

    // wet overlay
    if (weather.wet > 0.01) {
      ctx.strokeStyle = `rgba(80,140,255,${0.14 + weather.wet*0.20})`;
      ctx.lineWidth = 20;
      ctx.beginPath();
      ctx.ellipse(rect.x+rect.w/2, rect.y+rect.h/2, rect.w/2, rect.h/2, 0, 0, Math.PI*2);
      ctx.stroke();
    }

    // caution banner
    if (flag === "YELLOW") {
      ctx.fillStyle = 'rgba(255,200,0,0.18)';
      ctx.fillRect(rect.x, rect.y + rect.h*0.45, rect.w, rect.h*0.10);
      ctx.fillStyle = 'rgba(120,80,0,0.9)';
      ctx.font = 'bold 14px -apple-system, system-ui';
      ctx.fillText(`CAUTION: ${cautionCause}`, rect.x + 10, rect.y + rect.h*0.52);
    }

    // cars
    const order = cars.slice().sort((a,b)=>b.prog - a.prog);
    for (let k=0;k<order.length;k++) {
      const car = order[k];
      if (car.dnf) continue;

      const t = car.prog % 1;
      const p = trackPoint(t, rect);

      const off = (k%6 - 2.5) * 2.2;
      const x = p.x + off;
      const y = p.y + off*0.4;

      const isYou = car.id === YOU;
      const r = isYou ? 5.4 : 4.3;

      let col = 'rgba(255,255,255,0.85)';
      if (car.tireType === "slick") col = isYou ? 'rgba(40,180,120,0.95)' : 'rgba(255,255,255,0.8)';
      if (car.tireType === "inter") col = isYou ? 'rgba(80,140,255,0.95)' : 'rgba(150,190,255,0.8)';
      if (car.tireType === "rain")  col = isYou ? 'rgba(255,210,80,0.95)' : 'rgba(255,220,120,0.78)';

      ctx.fillStyle = col;
      ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();

      if (car.inPit) {
        ctx.strokeStyle = 'rgba(255,120,120,0.9)';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(x, y, r+2.4, 0, Math.PI*2); ctx.stroke();
      }
      if (isYou) {
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(x, y, r+1.9, 0, Math.PI*2); ctx.stroke();
      }
    }

    ctx.restore();
  }

  let last = performance.now();
  function loop(now) {
    const dt = clamp((now - last)/1000, 0, 0.05);
    last = now;
    update(dt);
    requestAnimationFrame(loop);
  }

  init();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>